stages:
  - security
  - lint
  - test
  - build
  - deploy

variables:
  NODE_VERSION: "20"
  npm_config_cache: "$CI_PROJECT_DIR/.npm"
  npm_config_prefer_offline: "true"
  # Test Environment Variables
  JWT_SECRET: "test-secret-key-for-gitlab-ci"
  JWT_EXPIRES: "1h"
  NODE_ENV: "test"

before_script:
  - node --version
  - npm --version

secret_scan:
  stage: security
  image:
    name: zricethezav/gitleaks:v8.24.2
    entrypoint: [""]
  before_script: []
  script:
    - gitleaks detect --source . --config .gitleaks.toml --redact --no-banner
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
# Test stage
lint:
  stage: lint
  image: node:20-bullseye
  script:
    - npm ci
    - npm run arch:check
    - npm run migration:check
    - npm run lint
    - npm run format:check
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
      - .npm/
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test:
  stage: test
  image: node:20-bullseye
  script:
    - npm ci
    - npm run test:contracts
    - npm run test:integration
    - npm run test
  cache:
    key: 
      files:
        - package-lock.json
    paths:
      - node_modules/
      - .npm/
  artifacts:
    reports:
      junit:
        - "reports/junit.xml"
    expire_in: 1 day
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Build Docker image
build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t swiftly-backend:$CI_COMMIT_SHA .
  rules:
    - if: $CI_COMMIT_TAG

deploy_production:
  stage: deploy
  image: alpine:latest
  script:
    - apk add --no-cache curl
    - curl -X POST $RENDER_DEPLOY_HOOK_URL
  environment:
    name: production
    url: https://swiftly-backend.onrender.com
  rules:
    - if: $CI_COMMIT_TAG
  when: manual

deploy_development:
  stage: deploy
  image: alpine:latest
  script:
    - apk add --no-cache curl
    - curl -X POST $RENDER_DEPLOY_HOOK_DEV_URL
  environment:
    name: development
    url: https://swiftly-backend-dev.onrender.com
  rules:
    - if: $CI_COMMIT_TAG
  when: manual

