stages:
  - lint
  - test
  - build
  - deploy

variables:
  NODE_VERSION: "20"

before_script:
  - node --version
  - npm --version

# Lint stage
lint:
  stage: lint
  image: node:20-alpine
  script:
    - npm ci
    - npm run lint
  cache:
    key: $CI_COMMIT_REF_SLUG
    paths:
      - node_modules/
    only:
      - merge_requests
      - develop
      - main

# Test stage
test:
  stage: test
  image: node:20-alpine
  script:
    - npm ci
    - npm run test
  cache:
      key: $CI_COMMIT_REF_SLUG
      paths:
        - node_modules/
  only:
      - merge_requests
      - develop
      - main

# Build Docker image
build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t scooteq-helpdesk-backend:$CI_COMMIT_SHA .
  only:
    - develop
    - main
    - tags

deploy_production:
  stage: deploy
  image: alpine:latest
  script:
    - apk add --no-cache curl
    - curl -X POST $RENDER_DEPLOY_HOOK_URL
  environment:
    name: production
    url: https://scooteq-helpdesk-backend.onrender.com
  only:
    - tags
  when: manual

deploy_development:
  stage: deploy
  image: alpine:latest
  script:
    - apk add --no-cache curl
    - curl -X POST $RENDER_DEPLOY_HOOK_DEV_URL
  environment:
    name: development
    url: https://scooteq-helpdesk-backend-dev.onrender.com
  only:
    - develop
  when: manual
