name: CI/CD

on:
  pull_request:
  push:
    branches:
      - main
    tags:
      - "*"
  workflow_dispatch:
    inputs:
      deploy_target:
        description: "Manual deploy target"
        required: true
        type: choice
        options:
          - production
          - development

permissions:
  contents: read

env:
  NODE_VERSION: "20"
  JWT_SECRET: "test-secret-key-for-github-ci"
  JWT_EXPIRES: "1h"
  NODE_ENV: "test"

jobs:
  security_ioc_scan:
    name: Security IOC Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Validate IOC scanner
        run: bash ./.github/scripts/security-ioc-scan-self-test.sh
      - name: Scan for known toolchain IOC patterns
        run: bash ./.github/scripts/security-ioc-scan.sh

  secret_scan:
    name: Secret Scan
    runs-on: ubuntu-latest
    needs: security_ioc_scan
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install gitleaks
        run: |
          GITLEAKS_VERSION="v8.24.2"
          GITLEAKS_ASSET="gitleaks_${GITLEAKS_VERSION#v}_linux_x64.tar.gz"
          curl -sSfL "https://github.com/gitleaks/gitleaks/releases/download/${GITLEAKS_VERSION}/${GITLEAKS_ASSET}" -o /tmp/gitleaks.tar.gz
          tar -xzf /tmp/gitleaks.tar.gz -C /tmp gitleaks
          install -m 0755 /tmp/gitleaks /usr/local/bin/gitleaks
          gitleaks version
      - name: Run gitleaks
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          gitleaks detect --source . --config .gitleaks.toml --redact --no-banner

  dependency_audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    needs: secret_scan
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Install deps
        run: npm ci
      - name: Run npm audit (prod deps, high+)
        run: npm audit --omit=dev --audit-level=high

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: dependency_audit
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Install deps
        run: npm ci
      - name: Lint
        run: npm run lint
      - name: Format check
        run: npm run format:check

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - name: Install deps
        run: npm ci
      - name: Run tests
        run: npm test

  build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build image
        run: docker build -t swiftly-backend:${{ github.sha }} .

  deploy_production:
    name: Deploy Production
    runs-on: ubuntu-latest
    needs: build
    if: |
      startsWith(github.ref, 'refs/tags/') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_target == 'production')
    steps:
      - name: Trigger Render production deploy
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK_URL" ]; then
            echo "RENDER_DEPLOY_HOOK_URL is not set"
            exit 1
          fi
          curl -X POST "$RENDER_DEPLOY_HOOK_URL"
    environment:
      name: production
      url: https://swiftly-backend.onrender.com

  deploy_development:
    name: Deploy Development
    runs-on: ubuntu-latest
    needs: build
    if: |
      startsWith(github.ref, 'refs/tags/') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_target == 'development')
    steps:
      - name: Trigger Render development deploy
        env:
          RENDER_DEPLOY_HOOK_DEV_URL: ${{ secrets.RENDER_DEPLOY_HOOK_DEV_URL }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK_DEV_URL" ]; then
            echo "RENDER_DEPLOY_HOOK_DEV_URL is not set"
            exit 1
          fi
          curl -X POST "$RENDER_DEPLOY_HOOK_DEV_URL"
    environment:
      name: development
      url: https://swiftly-backend-dev.onrender.com
